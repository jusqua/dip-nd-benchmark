#!/usr/bin/env bash

BUILD_FOLDER=./build
CSV_FILENAME="benchmark.csv"
LOG_FILENAME="benchmark.log"
OUTPUT_FOLDER_BASE="../results"
IMAGE_PATTERN="../assets/mitosis/mitosis-5d%04d.tif"
INDEX_0=0
INDEX_N=335
ROUNDS=${1:-0}

echo "Building AdaptiveCPP SYCL benchmark"
rm -rf $BUILD_FOLDER
cmake -G Ninja -S . -B $BUILD_FOLDER -D CMAKE_BUILD_TYPE=Release -D CMAKE_LINKER_TYPE=LLD -D CMAKE_CXX_COMPILER=acpp > /dev/null 2>&1
cmake --build $BUILD_FOLDER > /dev/null 2>&1

OUTPUT_FOLDER="$OUTPUT_FOLDER_BASE/acpp-sycl-l1"
mkdir -p "$OUTPUT_FOLDER/1D" "$OUTPUT_FOLDER/2D" "$OUTPUT_FOLDER/3D" "$OUTPUT_FOLDER/4D" "$OUTPUT_FOLDER/5D"
echo "Running AdaptiveCPP SYCL L1 1D benchmark"
ACPP_DEBUG_LEVEL=0 ACPP_ADAPTIVITY_LEVEL=1 $BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/1D 22020096       > "$OUTPUT_FOLDER/1D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/1D/$LOG_FILENAME"
echo "Running AdaptiveCPP SYCL L1 2D benchmark"
ACPP_DEBUG_LEVEL=0 ACPP_ADAPTIVITY_LEVEL=1 $BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/2D 256 86016      > "$OUTPUT_FOLDER/2D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/2D/$LOG_FILENAME"
echo "Running AdaptiveCPP SYCL L1 3D benchmark"
ACPP_DEBUG_LEVEL=0 ACPP_ADAPTIVITY_LEVEL=1 $BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/3D 256 256 336    > "$OUTPUT_FOLDER/3D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/3D/$LOG_FILENAME"
echo "Running AdaptiveCPP SYCL L1 4D benchmark"
ACPP_DEBUG_LEVEL=0 ACPP_ADAPTIVITY_LEVEL=1 $BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/4D 256 256 2 168  > "$OUTPUT_FOLDER/4D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/4D/$LOG_FILENAME"
echo "Running AdaptiveCPP SYCL L1 5D benchmark"
ACPP_DEBUG_LEVEL=0 ACPP_ADAPTIVITY_LEVEL=1 $BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/5D 256 256 2 24 7 > "$OUTPUT_FOLDER/5D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/5D/$LOG_FILENAME"
echo "Results and logs saved in $(realpath $OUTPUT_FOLDER)"

OUTPUT_FOLDER="$OUTPUT_FOLDER_BASE/acpp-sycl-l2"
mkdir -p "$OUTPUT_FOLDER/1D" "$OUTPUT_FOLDER/2D" "$OUTPUT_FOLDER/3D" "$OUTPUT_FOLDER/4D" "$OUTPUT_FOLDER/5D"
echo "Running AdaptiveCPP SYCL L2 1D benchmark"
ACPP_DEBUG_LEVEL=0 ACPP_ADAPTIVITY_LEVEL=2 $BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/1D 22020096       > "$OUTPUT_FOLDER/1D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/1D/$LOG_FILENAME"
echo "Running AdaptiveCPP SYCL L2 2D benchmark"
ACPP_DEBUG_LEVEL=0 ACPP_ADAPTIVITY_LEVEL=2 $BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/2D 256 86016      > "$OUTPUT_FOLDER/2D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/2D/$LOG_FILENAME"
echo "Running AdaptiveCPP SYCL L2 3D benchmark"
ACPP_DEBUG_LEVEL=0 ACPP_ADAPTIVITY_LEVEL=2 $BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/3D 256 256 336    > "$OUTPUT_FOLDER/3D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/3D/$LOG_FILENAME"
echo "Running AdaptiveCPP SYCL L2 4D benchmark"
ACPP_DEBUG_LEVEL=0 ACPP_ADAPTIVITY_LEVEL=2 $BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/4D 256 256 2 168  > "$OUTPUT_FOLDER/4D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/4D/$LOG_FILENAME"
echo "Running AdaptiveCPP SYCL L2 5D benchmark"
ACPP_DEBUG_LEVEL=0 ACPP_ADAPTIVITY_LEVEL=2 $BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/5D 256 256 2 24 7 > "$OUTPUT_FOLDER/5D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/5D/$LOG_FILENAME"
echo "Results and logs saved in $(realpath $OUTPUT_FOLDER)"

echo "Building Intel LLVM SYCL benchmark"
rm -rf $BUILD_FOLDER
cmake -G Ninja -S . -B $BUILD_FOLDER -D CMAKE_BUILD_TYPE=Release -D CMAKE_CXX_COMPILER=icpx -D CMAKE_CXX_FLAGS="-fsycl -fsycl-targets=nvidia_gpu_sm_90" > /dev/null 2>&1
cmake --build $BUILD_FOLDER > /dev/null 2>&1

OUTPUT_FOLDER="$OUTPUT_FOLDER_BASE/intel-sycl"
mkdir -p "$OUTPUT_FOLDER/1D" "$OUTPUT_FOLDER/2D" "$OUTPUT_FOLDER/3D" "$OUTPUT_FOLDER/4D" "$OUTPUT_FOLDER/5D"
echo "Running Intel LLVM SYCL 1D benchmark"
$BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/1D 22020096       > "$OUTPUT_FOLDER/1D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/1D/$LOG_FILENAME"
echo "Running Intel LLVM SYCL 2D benchmark"
$BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/2D 256 86016      > "$OUTPUT_FOLDER/2D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/2D/$LOG_FILENAME"
echo "Running Intel LLVM SYCL 3D benchmark"
$BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/3D 256 256 336    > "$OUTPUT_FOLDER/3D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/3D/$LOG_FILENAME"
echo "Running Intel LLVM SYCL 4D benchmark"
$BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/4D 256 256 2 168  > "$OUTPUT_FOLDER/4D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/4D/$LOG_FILENAME"
echo "Running Intel LLVM SYCL 5D benchmark"
$BUILD_FOLDER/benchmark $IMAGE_PATTERN $INDEX_0 $INDEX_N $ROUNDS $OUTPUT_FOLDER/5D 256 256 2 24 7 > "$OUTPUT_FOLDER/5D/$CSV_FILENAME" 2> "$OUTPUT_FOLDER/5D/$LOG_FILENAME"
echo "Results and logs saved in $(realpath $OUTPUT_FOLDER)"
